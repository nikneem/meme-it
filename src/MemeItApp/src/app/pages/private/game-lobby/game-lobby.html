<div class="sunray-container"></div>
<div class="lobby-container">
  <div class="lobby-content" *ngIf="!isLoading && game">
    <header class="lobby-header">
      <div class="header-top">
        <h1 class="lobby-title">Game Lobby</h1>
        <div class="game-status-badge" [class.lobby]="game.state === 'Lobby'"
          [class.in-progress]="game.state === 'InProgress'">
          <mat-icon>{{ game.state === 'Lobby' ? 'groups' : 'sports_esports' }}</mat-icon>
          <span>{{ game.state === 'Lobby' ? 'Waiting for Players' : game.state }}</span>
        </div>
      </div>

      <div class="game-code-section">
        <div class="code-container">
          <span class="code-label">Game Code</span>
          <div class="code-display">
            <span class="code-value">{{ gameCode }}</span>
            <button mat-icon-button (click)="copyGameCode()" class="copy-button" title="Copy game code">
              <mat-icon>content_copy</mat-icon>
            </button>
          </div>
        </div>
        <div class="game-stats">
          <div class="stat-item">
            <mat-icon>people</mat-icon>
            <span>{{ playerCount }} Player{{ playerCount !== 1 ? 's' : '' }}</span>
          </div>
          <div class="stat-item" *ngIf="game.state === 'Lobby'">
            <mat-icon>check_circle</mat-icon>
            <span>{{ readyPlayerCount }}/{{ playerCount }} Ready</span>
          </div>
          <div class="stat-item" *ngIf="game.rounds.length > 0">
            <mat-icon>emoji_events</mat-icon>
            <span>Round {{ game.rounds.length }}</span>
          </div>
        </div>
      </div>
    </header>

    <section class="players-section">
      <div class="section-header">
        <h2>Players</h2>
        <span class="player-count-badge">{{ playerCount }}</span>
      </div>

      <div class="players-grid">
        <div *ngFor="let player of game.players" class="player-card" [class.ready]="player.isReady"
          [class.admin]="game.isAdmin && player.playerId === game.players[0].playerId">
          <!-- Column 1: Avatar -->
          <div class="player-avatar">
            <mat-icon>{{ player.isReady ? 'person' : 'person_outline' }}</mat-icon>
          </div>

          <!-- Column 2: Name and Admin Badge -->
          <div class="player-info">
            <div class="player-name">{{ player.displayName }}</div>
          </div>

          <!-- Column 3: Controls (Delete button above Ready indication) -->
          <div class="player-controls">
            <!-- Delete button (admin only, for other players) -->
            <div class="player-badges">
              <span class="badge admin-badge" *ngIf="game.isAdmin && player.playerId === game.players[0].playerId">
                <mat-icon>stars</mat-icon>
                Admin
              </span>
            </div>
            <button *ngIf="isAdmin && !isCurrentUser(player.playerId)" mat-icon-button color="warn"
              (click)="removePlayer(player.playerId)" title="Remove player from game" class="delete-button">
              <mat-icon>delete_outline</mat-icon>
            </button>

            <!-- Ready toggle for current user -->
            <div class="ready-toggle-container" *ngIf="isCurrentUser(player.playerId) && game.state === 'Lobby'">
              <mat-slide-toggle [checked]="player.isReady" (change)="toggleReady(player)" color="primary">
                {{ player.isReady ? 'Ready' : 'Not Ready' }}
              </mat-slide-toggle>
            </div>

            <!-- Ready status for other players -->
            <div class="ready-status" *ngIf="!isCurrentUser(player.playerId)">
              <span class="badge ready-badge" *ngIf="player.isReady">
                <mat-icon>check_circle</mat-icon>
                Ready
              </span>
              <span class="badge not-ready-badge" *ngIf="!player.isReady">
                <mat-icon>schedule</mat-icon>
                Not Ready
              </span>
            </div>
          </div>
        </div>
      </div>
    </section>

    <footer class="lobby-actions">
      <button mat-raised-button color="warn" (click)="leaveGame()" class="action-btn secondary-btn">
        <mat-icon>exit_to_app</mat-icon>
        Leave Game
      </button>

      <button mat-raised-button color="primary" *ngIf="isAdmin" (click)="startGame()"
        [disabled]="playerCount < 2 || !allPlayersReady" class="action-btn primary-btn">
        <mat-icon>play_arrow</mat-icon>
        Start Game
      </button>
    </footer>
  </div>

  <div class="loading-state" *ngIf="isLoading">
    <mat-spinner diameter="60"></mat-spinner>
    <p>Loading game...</p>
  </div>

  <div class="error-state" *ngIf="!isLoading && !game && errorMessage">
    <mat-icon class="error-icon">error_outline</mat-icon>
    <p>{{ errorMessage }}</p>
    <button mat-raised-button color="primary" routerLink="/">
      Return to Home
    </button>
  </div>
</div>