<div class="sunray-container"></div>
<div class="lobby-container">
  <div class="lobby-content" *ngIf="!isLoading && game">
    <header class="lobby-header">
      <div class="header-top">
        <h1 class="lobby-title">Game Lobby</h1>
        <div class="game-status-badge" [class.lobby]="game.state === 'Lobby'"
          [class.in-progress]="game.state === 'InProgress'">
          <mat-icon>{{ game.state === 'Lobby' ? 'groups' : 'sports_esports' }}</mat-icon>
          <span>{{ game.state === 'Lobby' ? 'Waiting for Players' : game.state }}</span>
        </div>
      </div>

      <div class="game-code-section">
        <div class="code-container">
          <span class="code-label">Game Code</span>
          <div class="code-display">
            <span class="code-value">{{ gameCode }}</span>
            <button mat-icon-button (click)="copyGameCode()" class="copy-button" title="Copy game code">
              <mat-icon>content_copy</mat-icon>
            </button>
          </div>
        </div>
        <div class="game-stats">
          <div class="stat-item">
            <mat-icon>people</mat-icon>
            <span>{{ playerCount }} Player{{ playerCount !== 1 ? 's' : '' }}</span>
          </div>
          <div class="stat-item" *ngIf="game.state === 'Lobby'">
            <mat-icon>check_circle</mat-icon>
            <span>{{ readyPlayerCount }}/{{ playerCount }} Ready</span>
          </div>
          <div class="stat-item" *ngIf="game.rounds.length > 0">
            <mat-icon>emoji_events</mat-icon>
            <span>Round {{ game.rounds.length }}</span>
          </div>
        </div>
      </div>
    </header>

    <section class="players-section">
      <div class="section-header">
        <h2>Players</h2>
        <span class="player-count-badge">{{ playerCount }}</span>
      </div>

      <div class="players-grid">
        <mat-card *ngFor="let player of game.players" class="player-card" [class.ready]="player.isReady">
          <mat-card-header>
            <mat-card-title>{{ player.displayName }}</mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <div class="card-body">
              <!-- Player Icon -->
              <div class="player-avatar">
                <mat-icon>{{ player.isReady ? 'person' : 'person_outline' }}</mat-icon>
              </div>

              <!-- Badges Stack -->
              <div class="badges-container">
                <!-- Ready Badge -->
                <div class="badge-item ready-badge" [class.not-ready]="!player.isReady">
                  <mat-icon>{{ player.isReady ? 'check' : 'close' }}</mat-icon>
                  <span>Ready</span>
                </div>

                <!-- Delete Badge (only for admin, not for current user or admin player) -->
                <div class="badge-item delete-badge"
                  *ngIf="isAdmin && !isCurrentUser(player.playerId) && !isPlayerAdmin(player.playerId)"
                  (click)="removePlayer(player.playerId)">
                  <mat-icon>delete</mat-icon>
                  <span>Delete</span>
                </div>

                <!-- Admin Badge (only for game admin player) -->
                <div class="badge-item admin-badge" *ngIf="isPlayerAdmin(player.playerId)">
                  <mat-icon>workspace_premium</mat-icon>
                  <span>Admin</span>
                </div>


                <button matButton="tonal" *ngIf="!player.isReady && isCurrentUser(player.playerId)"
                  (click)="setPlayerReady()" class="set-ready-button" title="Set player ready">
                  <mat-icon>check</mat-icon>
                  <span>Set Ready</span>
                </button>
              </div>
            </div>

          </mat-card-content>
        </mat-card>
      </div>
    </section>

    <footer class="lobby-actions">
      <button mat-raised-button color="warn" (click)="leaveGame()" class="action-btn secondary-btn">
        <mat-icon>exit_to_app</mat-icon>
        Leave Game
      </button>

      <button mat-raised-button color="primary" *ngIf="isAdmin" (click)="startGame()"
        [disabled]="playerCount < 2 || !allPlayersReady" class="action-btn primary-btn">
        <mat-icon>play_arrow</mat-icon>
        Start Game
      </button>
    </footer>
  </div>

  <div class="loading-state" *ngIf="isLoading">
    <mat-spinner diameter="60"></mat-spinner>
    <p>Loading game...</p>
  </div>

  <div class="error-state" *ngIf="!isLoading && !game && errorMessage">
    <mat-icon class="error-icon">error_outline</mat-icon>
    <p>{{ errorMessage }}</p>
    <button mat-raised-button color="primary" routerLink="/">
      Return to Home
    </button>
  </div>
</div>