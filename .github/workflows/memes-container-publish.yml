name: Memes Service - Build & Publish Container

on:
  push:
    branches:
      - main
    paths:
      - 'src/Memes/**'
      - 'src/HexMaster.MemeIt.Core/**'
      - 'src/HexMaster.MemeIt.IntegrationEvents/**'
      - '.github/workflows/memes-container-publish.yml'

jobs:
  build-and-test:
    name: Build & Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
        
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'
          
      - name: Restore dependencies
        run: dotnet restore src/Memes/HexMaster.MemeIt.Memes.Api/HexMaster.MemeIt.Memes.Api.csproj
        
      - name: Build
        run: dotnet build src/Memes/HexMaster.MemeIt.Memes.Api/HexMaster.MemeIt.Memes.Api.csproj --no-restore --configuration Release
        
      - name: Run tests with coverage
        run: |
          dotnet test src/Memes/HexMaster.MemeIt.Memes.Tests/HexMaster.MemeIt.Memes.Tests.csproj \
            --configuration Release \
            --collect:"XPlat Code Coverage" \
            --results-directory ./TestResults \
            --settings src/Memes/HexMaster.MemeIt.Memes.Tests/coverlet.runsettings \
            --logger "console;verbosity=normal"
        
      - name: Install ReportGenerator
        run: dotnet tool install --global dotnet-reportgenerator-globaltool
        
      - name: Generate coverage report
        run: |
          COVERAGE_FILE=$(find ./TestResults -name "coverage.cobertura.xml" -type f | head -1)
          if [ -n "$COVERAGE_FILE" ] && [ -f "$COVERAGE_FILE" ]; then
            echo "Found coverage file: $COVERAGE_FILE"
            reportgenerator -reports:"$COVERAGE_FILE" -targetdir:./coveragereport -reporttypes:"Html;Cobertura" -filefilters:-**/Migrations/**
          else
            echo "No coverage file found, creating empty report"
            mkdir -p ./coveragereport
            echo '<?xml version="1.0" encoding="utf-8"?><coverage line-rate="0" branch-rate="0" version="1.9"></coverage>' > ./coveragereport/Cobertura.xml
          fi

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: memes-coverage-report-${{ github.run_number }}
          path: coveragereport/
          retention-days: 30
        
      - name: Validate coverage threshold
        run: |
          COVERAGE=$(grep -oP 'line-rate="\K[0-9.]+' ./coveragereport/Cobertura.xml | head -1)
          COVERAGE_PERCENT=$(echo "$COVERAGE * 100" | bc)
          echo "Coverage: $COVERAGE_PERCENT%"
          if (( $(echo "$COVERAGE_PERCENT < 80" | bc -l) )); then
            echo "❌ Coverage is below 80% threshold ($COVERAGE_PERCENT%)"
            exit 1
          fi
          echo "✅ Coverage meets 80% threshold ($COVERAGE_PERCENT%)"
  
  publish-container:
    name: Publish Container
    runs-on: ubuntu-latest
    needs: build-and-test
    permissions:
      id-token: write
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
        
      - name: Install GitVersion
        uses: gittools/actions/gitversion/setup@v4.2.0
        with:
          versionSpec: '6.4.x'
          
      - name: Execute GitVersion
        id: gitversion
        uses: gittools/actions/gitversion/execute@v4.2.0
        
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'
        
      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      
      - name: Log in to Azure Container Registry
        run: |
          az acr login --name ${{ secrets.CONTAINER_REGISTRY_USERNAME }}
        
      - name: Publish container
        run: |
          dotnet publish src/Memes/HexMaster.MemeIt.Memes.Api/HexMaster.MemeIt.Memes.Api.csproj \
            --configuration Release \
            --os linux \
            --arch x64 \
            /t:PublishContainer \
            /p:ContainerRegistry=${{ secrets.CONTAINER_REGISTRY_SERVER }} \
            /p:ContainerRepository=memeit/memes-api \
            /p:ContainerImageTag=${{ steps.gitversion.outputs.semVer }}
      
      - name: Deploy to Azure Container Apps
        env:
          POSTGRES_ADMIN_PASSWORD: ${{ secrets.MEMEIT_POSTGRESS_DB_PASSWORD }}
          MANAGEMENT_API_KEY: ${{ secrets.MEMEIT_MEMES_API_KEY }}
        run: |
          az deployment sub create \
            --name "memes-deploy-${{ github.run_number }}" \
            --location northeurope \
            --template-file src/Memes/infrastructure/main.bicep \
            --parameters src/Memes/infrastructure/main.bicepparam \
            --parameters containerImage="${{ secrets.CONTAINER_REGISTRY_SERVER }}/memeit/memes-api:${{ steps.gitversion.outputs.semVer }}" \
            --parameters postgresAdminPassword="$POSTGRES_ADMIN_PASSWORD"
